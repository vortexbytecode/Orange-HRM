name: üîí Security Scanning

on:
  # Scheduled security scans (enterprise standard)
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC
    - cron: '0 14 * * 5' # Every Friday at 2 PM UTC (pre-weekend)
  
  # Manual trigger for immediate security assessment
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - dependencies
          - code
          - secrets
      severity_threshold:
        description: 'Minimum severity to report'
        required: false
        default: 'medium'
        type: choice
        options:
          - low
          - medium
          - high
          - critical
  
  # Trigger on security-related file changes
  push:
    branches: [main, develop]
    paths:
      - 'requirements.txt'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/security-scan.yml'

env:
  PYTHON_VERSION_FILE: .python-version
  SECURITY_REPORTS_DIR: security-reports
  RETENTION_DAYS: 90

jobs:
  # ================================
  # DEPENDENCY VULNERABILITY SCANNING
  # ================================
  dependency-scan:
    name: üîç Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write  # Required for SARIF upload
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ${{ env.PYTHON_VERSION_FILE }}
          
      - name: ‚ö° Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          
      - name: üì¶ Install Dependencies
        run: uv sync --dev --frozen
        
      - name: üìã Create Reports Directory
        run: mkdir -p ${{ env.SECURITY_REPORTS_DIR }}
        
      - name: üõ°Ô∏è Run Safety Check (Dependency Vulnerabilities)
        run: |
          uv run safety check \
            --json \
            --output ${{ env.SECURITY_REPORTS_DIR }}/safety-report.json \
            --continue-on-error || true
          
          # Generate human-readable report
          uv run safety check \
            --output ${{ env.SECURITY_REPORTS_DIR }}/safety-report.txt \
            --continue-on-error || true
        
      - name: üìä Safety Report Summary
        if: always()
        run: |
          if [ -f "${{ env.SECURITY_REPORTS_DIR }}/safety-report.json" ]; then
            echo "## üõ°Ô∏è Dependency Security Scan Results" >> $GITHUB_STEP_SUMMARY
            
            # Count vulnerabilities by severity
            CRITICAL=$(jq '[.vulnerabilities[] | select(.severity == "CRITICAL")] | length' ${{ env.SECURITY_REPORTS_DIR }}/safety-report.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.vulnerabilities[] | select(.severity == "HIGH")] | length' ${{ env.SECURITY_REPORTS_DIR }}/safety-report.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.vulnerabilities[] | select(.severity == "MEDIUM")] | length' ${{ env.SECURITY_REPORTS_DIR }}/safety-report.json 2>/dev/null || echo "0")
            LOW=$(jq '[.vulnerabilities[] | select(.severity == "LOW")] | length' ${{ env.SECURITY_REPORTS_DIR }}/safety-report.json 2>/dev/null || echo "0")
            
            echo "- üî¥ Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- üü° High: $HIGH" >> $GITHUB_STEP_SUMMARY  
            echo "- üü† Medium: $MEDIUM" >> $GITHUB_STEP_SUMMARY
            echo "- üîµ Low: $LOW" >> $GITHUB_STEP_SUMMARY
          fi
        
      - name: üö® Fail on Critical Vulnerabilities
        run: |
          if [ -f "${{ env.SECURITY_REPORTS_DIR }}/safety-report.json" ]; then
            CRITICAL_COUNT=$(jq '[.vulnerabilities[] | select(.severity == "CRITICAL")] | length' ${{ env.SECURITY_REPORTS_DIR }}/safety-report.json 2>/dev/null || echo "0")
            if [ "$CRITICAL_COUNT" -gt "0" ]; then
              echo "‚ùå CRITICAL vulnerabilities found: $CRITICAL_COUNT"
              echo "üö® Enterprise policy: Critical vulnerabilities must be addressed immediately"
              exit 1
            fi
          fi

  # ================================
  # CODE SECURITY ANALYSIS
  # ================================
  code-security:
    name: üîç Code Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ${{ env.PYTHON_VERSION_FILE }}
          
      - name: ‚ö° Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          
      - name: üì¶ Install Dependencies
        run: uv sync --dev --frozen
        
      - name: üìã Create Reports Directory
        run: mkdir -p ${{ env.SECURITY_REPORTS_DIR }}
        
      - name: üîí Run Bandit Security Scan
        run: |
          uv run bandit -r src/ \
            -f json \
            -o ${{ env.SECURITY_REPORTS_DIR }}/bandit-report.json \
            -ll || true  # Low confidence, Low severity minimum
          
          # Generate human-readable report
          uv run bandit -r src/ \
            -f txt \
            -o ${{ env.SECURITY_REPORTS_DIR }}/bandit-report.txt \
            -ll || true
        
      - name: üìä Bandit Report Summary
        if: always()
        run: |
          if [ -f "${{ env.SECURITY_REPORTS_DIR }}/bandit-report.json" ]; then
            echo "## üîí Code Security Analysis Results" >> $GITHUB_STEP_SUMMARY
            
            # Parse Bandit results
            HIGH_ISSUES=$(jq '.results | map(select(.issue_severity == "HIGH")) | length' ${{ env.SECURITY_REPORTS_DIR }}/bandit-report.json 2>/dev/null || echo "0")
            MEDIUM_ISSUES=$(jq '.results | map(select(.issue_severity == "MEDIUM")) | length' ${{ env.SECURITY_REPORTS_DIR }}/bandit-report.json 2>/dev/null || echo "0")
            LOW_ISSUES=$(jq '.results | map(select(.issue_severity == "LOW")) | length' ${{ env.SECURITY_REPORTS_DIR }}/bandit-report.json 2>/dev/null || echo "0")
            
            echo "- üî¥ High Severity: $HIGH_ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "- üü° Medium Severity: $MEDIUM_ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "- üîµ Low Severity: $LOW_ISSUES" >> $GITHUB_STEP_SUMMARY
            
            # Show specific high-severity issues
            if [ "$HIGH_ISSUES" -gt "0" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### üö® High Severity Issues:" >> $GITHUB_STEP_SUMMARY
              jq -r '.results[] | select(.issue_severity == "HIGH") | "- **\(.test_name)**: \(.issue_text) (\(.filename):\(.line_number))"' ${{ env.SECURITY_REPORTS_DIR }}/bandit-report.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
            fi
          fi

  # ================================
  # SECRET SCANNING
  # ================================
  secret-scan:
    name: üîç Secret Detection Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive secret detection
          
      - name: üîç Run TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified
          
      - name: üìã Create Reports Directory
        run: mkdir -p ${{ env.SECURITY_REPORTS_DIR }}
        
      - name: üîê Manual Secret Pattern Check
        run: |
          echo "## üîê Secret Pattern Analysis" >> $GITHUB_STEP_SUMMARY
          
          # Check for common secret patterns
          echo "Scanning for potential secrets..." > ${{ env.SECURITY_REPORTS_DIR }}/secret-patterns.txt
          
          # API Keys
          API_KEYS=$(grep -r -n -i "api[_-]key\|apikey" --include="*.py" --include="*.json" --include="*.yaml" --include="*.yml" . | grep -v ".git" | wc -l || echo "0")
          
          # Passwords in code
          PASSWORDS=$(grep -r -n -i "password\s*=" --include="*.py" . | grep -v ".git" | grep -v "example" | wc -l || echo "0")
          
          # Tokens
          TOKENS=$(grep -r -n -i "token\|secret" --include="*.py" --include="*.json" . | grep -v ".git" | grep -v "example" | wc -l || echo "0")
          
          echo "- üîë Potential API Keys: $API_KEYS" >> $GITHUB_STEP_SUMMARY
          echo "- üîí Potential Passwords: $PASSWORDS" >> $GITHUB_STEP_SUMMARY
          echo "- üéüÔ∏è Potential Tokens: $TOKENS" >> $GITHUB_STEP_SUMMARY
          
          if [ "$API_KEYS" -gt "0" ] || [ "$PASSWORDS" -gt "0" ] || [ "$TOKENS" -gt "0" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **Manual Review Required**: Potential secrets detected in code" >> $GITHUB_STEP_SUMMARY
          fi

  # ================================
  # COMPREHENSIVE SECURITY REPORT
  # ================================
  security-report:
    name: üìã Security Report Consolidation
    needs: [dependency-scan, code-security, secret-scan]
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: üì• Download Security Reports
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: ${{ env.SECURITY_REPORTS_DIR }}/
        continue-on-error: true
        
      - name: üìä Generate Security Dashboard
        run: |
          echo "# üîí Enterprise Security Scan Report" > security-summary.md
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> security-summary.md
          echo "**Repository:** ${{ github.repository }}" >> security-summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> security-summary.md
          echo "**Commit:** ${{ github.sha }}" >> security-summary.md
          echo "**Trigger:** ${{ github.event_name }}" >> security-summary.md
          echo "" >> security-summary.md
          
          # Security posture summary
          echo "## üõ°Ô∏è Security Posture" >> security-summary.md
          echo "- ‚úÖ Dependency Scan: ${{ needs.dependency-scan.result }}" >> security-summary.md
          echo "- ‚úÖ Code Security: ${{ needs.code-security.result }}" >> security-summary.md  
          echo "- ‚úÖ Secret Detection: ${{ needs.secret-scan.result }}" >> security-summary.md
          echo "" >> security-summary.md
          
          # Overall status
          if [[ "${{ needs.dependency-scan.result }}" == "success" && "${{ needs.code-security.result }}" == "success" && "${{ needs.secret-scan.result }}" == "success" ]]; then
            echo "## ‚úÖ Overall Status: SECURE" >> security-summary.md
            echo "All security scans completed successfully with no critical issues." >> security-summary.md
          else
            echo "## ‚ö†Ô∏è Overall Status: REQUIRES ATTENTION" >> security-summary.md
            echo "One or more security scans require manual review." >> security-summary.md
          fi
        
      - name: üì§ Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: enterprise-security-reports-${{ github.run_number }}
          path: |
            ${{ env.SECURITY_REPORTS_DIR }}/
            security-summary.md
          retention-days: ${{ env.RETENTION_DAYS }}
          
      - name: üì¢ Security Alert Notification
        if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\":\"üö® Security Alert: OrangeHRM Test Automation\",
              \"blocks\":[
                {
                  \"type\":\"section\",
                  \"text\":{
                    \"type\":\"mrkdwn\",
                    \"text\":\"*üîí Security Scan Alert*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Status:* ‚ö†Ô∏è Requires Attention\n*Report:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>\n*Timestamp:* $(date -u '+%Y-%m-%d %H:%M:%S UTC')\"
                  }
                }
              ]
            }" \
            "$SLACK_WEBHOOK_URL" || echo "Slack notification failed"
          fi

# ================================
# ENTERPRISE SECURITY WORKFLOW
# ================================
# This workflow demonstrates:
# ‚úÖ Comprehensive security scanning strategy
# ‚úÖ Multiple scan types (dependencies, code, secrets)
# ‚úÖ Automated scheduling and manual triggers
# ‚úÖ Enterprise reporting and alerting
# ‚úÖ Proper artifact management
# ‚úÖ Security incident response workflow
# ‚úÖ Compliance with enterprise security standards
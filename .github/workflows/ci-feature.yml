# Run Chrome tests on Ubuntu. This is your cost-effective primary test.
# Run Edge tests on Windows. This covers the dominant browser on the Windows OS.
# Run Safari tests on macOS. This covers the WebKit engine and native Mac environment. 


name: Feature Branch Testing

on:
    push:
        branches:
            - 'feature/**'
            - 'bugfix/**'
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
  PYTHON_VERSION_FILE: .python-version
  ACTIONS_RUNNER_DEBUG: false
  ACTIONS_STEP_DEBUG: false
  ORANGEHRM_USERNAME: ${{ secrets.ORANGEHRM_USERNAME }}
  ORANGEHRM_PASSWORD: ${{ secrets.ORANGEHRM_PASSWORD }}

permissions:
  contents: read
  checks: write

jobs:
    smoke-tests:
        name: Smoke Tests (Chrome Only)
        runs-on: ubuntu-latest
        timeout-minutes: 15
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4
                with:
                    fetch-depth: 0

            -   name: Set up Python
                uses: actions/setup-python@v5
                with:
                    python-version-file: ${{ env.PYTHON_VERSION_FILE}}

            -   name: Restore uv Cache
                uses: actions/cache@v4
                with:
                    path: /tmp/.uv-cache
                    key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
                    restore-keys: |
                        uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
                        uv-${{ runner.os }}-

            -   name: Install uv (cached)
                uses: astral-sh/setup-uv@v6
                with:
                    enable-cache: true

            -   name: Install dependencies (locked)
                run: uv sync --dev --locked

            -   name: Ensure reports dir
                run: mkdir -p reports/

            -   name: Run Smoke Tests (Critical User Journeys)
                run: |
                    uv run pytest \
                        --cov-report=term-missing
                        --cov-report html=reports/coverage.html \
                        --cov-report json=reports/coverage.json \
                        --cov-report markdown-append:$GITHUB_STEP_SUMMARY \
                        --cov=orange_hrm tests \
                        --env dev \
                        --headless

            -   name: Upload Smoke Test Report
                if: always()
                uses: actions/upload-artifact@v4
                with:
                    name: smoke-test-report
                    path: reports/
                    retention-days: 7